<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Financeiro</title>
  <meta name="theme-color" content="#4b7bec" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#f5f5fa;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;

      --primary:#4b7bec;
      --primary-soft:#e7efff;

      --brad-soft:#fde8ea;
      --brad-pill:#e98d95;

      --bb-soft:#fff4cc;
      --bb-pill:#f4c247;

      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:14px 14px 6px 14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(90deg,var(--primary),#2d7a5b);
      color:#fff;
      border-radius:18px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }
    .topbar .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .chip{
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
    }

    main{
      padding:10px 14px 80px 14px;
      max-width:900px;
      margin:0 auto;
    }

    .view{display:none}
    .view.active{display:block}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.05);
      margin-bottom:12px;
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 6px 0;
      font-weight:700;
    }

    input,select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      width:100%;
      margin-top:12px;
    }
    .btn.secondary{background:#20bf6b}
    .btn.danger{background:#eb3b5a}
    .btn.small{width:auto;padding:10px 12px;border-radius:12px;font-weight:800}
.btn:disabled{opacity:.55;cursor:not-allowed}
input:disabled,select:disabled{opacity:.75}

    .hint{margin-top:8px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}

    nav{
      position:fixed;
      left:0;right:0;bottom:0;
      background:#ffffffee;
      backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
      padding:10px;
      justify-content:space-between;
      z-index:20;
    }
    nav button{
      flex:1;
      border:none;
      background:#eef2ff;
      color:#111827;
      border-radius:14px;
      padding:12px 6px;
      font-weight:800;
      cursor:pointer;
    }
    nav button.active{
      background:var(--primary);
      color:#fff;
    }

    .pillbar{
      display:flex;
      gap:10px;
      padding:10px;
      background:#eef2ff;
      border-radius:999px;
      border:1px solid var(--border);
      margin-top:8px;
    }
    .pill{
      flex:1;
      border:none;
      border-radius:999px;
      padding:12px 10px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--border);
    }
    .pill.active{
      background:var(--primary);
      color:#fff;
      border-color:transparent;
    }

    .brad-text{color:#b4232a}
    .bb-text{color:#b98000}

    .bankcard{
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:14px;
    }
    .bank-brad{background:var(--brad-soft)}
    .bank-bb{background:var(--bb-soft)}

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      font-size:15px;
    }
    .row.big{
      font-size:18px;
      font-weight:900;
      padding:6px 0 10px 0;
    }

    .tags{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      background:#eef2ff;
      border:1px solid var(--border);
    }
    .tag.brad{background:#ffe2e5;border-color:#ffd0d6;color:#9f1d25}
    .tag.bb{background:#fff0b3;border-color:#ffe38a;color:#8a5b00}
    .tag.tipo{background:#e1f2ea;border-color:#c7ead8;color:#1e5c43}

    .bars{margin-top:6px}
    .bar-row{margin:10px 0}
    .bar-head{display:flex;justify-content:space-between;gap:10px;font-weight:900}
    .bar-label{max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .bar-track{
      height:12px;border-radius:999px;background:#e5e7eb;margin-top:8px;overflow:hidden
    }
    .bar-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#20bf6b,#4b7bec,#eb3b5a);
      width:0%;
    }

.bar-fill.in {
  background: linear-gradient(90deg, #4b7bec, #6aa8ff);
}
.bar-fill.out {
  background: linear-gradient(90deg, #eb3b5a, #ff9aa8);
}
.bar-track.center {
  position: relative;
}
.bar-track.center::before{
  content:"";
  position:absolute;
  left:50%;
  top:0;
  bottom:0;
  width:2px;
  background:#ccc;
}
/* ===== Invest: barras divergentes ===== */
.bar-fill.in {
  background: linear-gradient(90deg, #4b7bec, #6aa8ff);
}

.bar-fill.out {
  background: linear-gradient(90deg, #eb3b5a, #ff9aa8);
}

.bar-track.center {
  position: relative;
}

.bar-track.center::before{
  content:"";
  position:absolute;
  left:50%;
  top:0;
  bottom:0;
  width:2px;
  background:#ccc;
}

/* ===== Chips visuais (lista Invest) ===== */
.tag.in {
  background:#e7efff;
  color:#1f4fd8;
}

.tag.out {
  background:#fde8ea;
  color:#9f1d25;
}

.tag.trf {
  background:#fff4cc;
  color:#8a5b00;
}


  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title">Financeiro</div>
      <div id="chip-month" class="chip">‚Äî</div>
    </div>
  </header>

  <main>
    <!-- LAN√áAR -->
    <section id="view-lancar" class="view active">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Novo lan√ßamento</h3>

        <label>Conta</label>
        <select id="conta">
          <option>Bradesco</option>
          <option>Banco do Brasil</option>
        </select>

        <label>Tipo</label>
        <select id="tipo">
          <option>Despesa</option>
          <option>Receita</option>
          <option>Transfer√™ncia</option>
        </select>
<label>Destino da transfer√™ncia</label>
<select id="destinoTrf">
  <option value="">‚Äî</option>
  <option value="BB">Banco do Brasil</option>
  <option value="BRAD">Bradesco</option>
</select>
<div class="hint">Use apenas quando Tipo = Transfer√™ncia.</div>


        <label>Categoria</label>
        <select id="categoria"></select>

        <label>Subcategoria</label>
        <select id="subcategoria"></select>

        <div id="invest-move-wrap" style="display:none">
          <label>Movimento (Invest)</label>
          <select id="invest-mov">
            <option value="aplic">Aplica√ß√£o/Compra (APLIC)</option>
            <option value="rend">Provento/Dividendo (REND)</option>
            <option value="retir">Resgate/Venda (RETIR)</option>
            <option value="ajuste+">Ajuste (+)</option>
            <option value="ajuste-">Ajuste (-)</option>
</select>
          <div class="hint">Para investimentos em modo fluxo: escolha se este lan√ßamento entra ou sai.</div>
        </div>

        <label>Valor</label>
        <input id="valor" type="number" step="0.01" />


        <label>Data (real)</label>
        <input id="data" type="date" />
        <div class="hint">Data do pagamento/recebimento. (Compet√™ncia √© o m√™s que entra no or√ßamento.)</div>

        <label>Compet√™ncia</label>
        <input id="competencia" type="month" />

        <label>Descri√ß√£o</label>
        <input id="descricao" placeholder="Ex.: mercado, uber, aporte..." />

        <button class="btn secondary" onclick="salvarLancamento()">Salvar</button>
        <div class="hint"></div>
      </div>
    </section>

    <!-- M√äS -->
    <section id="view-mes" class="view">
      <div class="card">
        <h3 style="margin:0 0 8px 0">M√™s</h3>

        <label>M√™s (compet√™ncia)</label>
        <select id="month"></select>

        <div class="pillbar" style="margin-top:6px">
          <button id="pill-brad" class="pill active brad-text" data-bank="Bradesco">Bradesco</button>
          <button id="pill-bb" class="pill bb-text" data-bank="Banco do Brasil">BB</button>
        </div>
        <div class="hint">Alternar banco muda o resumo e a lista.</div>
      </div>

      <div id="dashboard" class="card"></div>
      <div id="listagem" class="card"></div>
    </section>

    <!-- CART√ÉO -->
<section id="view-cartao" class="view">
  <div class="card">
    <h3 style="margin:0 0 8px 0">Cart√£o</h3>

    <label>M√™s (compet√™ncia)</label>
    <input id="card-month" type="month" />

    <div class="hint">Assinaturas e gastos gerais do cart√£o ficam aqui. O m√™s √© a cobran√ßa da fatura.</div>
  </div>

  
  <div class="card">
    <h3 style="margin:0 0 8px 0">Fechamento da fatura</h3>

    <div id="card-close-status" class="hint" style="margin-top:0">
      Fatura aberta. Ao fechar, o app cria um lan√ßamento de pagamento no m√™s escolhido.
    </div>

    <label>Conta para pagar</label>
    <select id="card-pay-account">
      <option>Bradesco</option>
      <option>Banco do Brasil</option>
    </select>

    <label>M√™s do pagamento</label>
    <input id="card-pay-month" type="month" />

    <label>Data (real) do pagamento</label>
    <input id="card-pay-date" type="date" />

    <button class="btn secondary" id="btnCloseCard" type="button" onclick="closeCardStatement()">‚úÖ Fechar fatura e gerar pagamento</button>
    <button class="btn danger" id="btnReopenCard" type="button" onclick="reopenCardStatement()" style="display:none">‚Ü©Ô∏è Reabrir fatura</button>

    <div class="hint">Fechar congela a fatura do m√™s selecionado e cria um lan√ßamento de pagamento no m√™s escolhido.</div>
  </div>

<div class="card">
    <h3 style="margin:0 0 8px 0">Novo gasto no cart√£o</h3>

    <label>Data (real)</label>
    <input id="card-date" type="date" />
    <div class="hint">Data da compra/pagamento. (Compet√™ncia √© o m√™s da fatura.)</div>

    <label>Categoria</label>
    <select id="card-categoria"></select>

    <label>Subcategoria</label>
    <select id="card-subcategoria"></select>

    <label>Valor</label>
    <input id="card-valor" type="number" step="0.01" />

    <label>Descri√ß√£o</label>
    <input id="card-descricao" placeholder="Ex.: mercado, farm√°cia, app..." />

    <button class="btn secondary" type="button" id="btn-card-save" onclick="salvarCartaoGasto()">Salvar gasto do cart√£o</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Assinaturas</h3>
    <div class="hint" style="margin-top:0">Cadastre suas assinaturas e deixe o app lan√ßar automaticamente na fatura do m√™s.</div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <button class="btn small" type="button" id="btn-add-sub" onclick="addSubscription()">+ Cadastrar assinatura</button>
      <button class="btn small" type="button" id="btn-refresh-card" onclick="renderCartao()">‚Üª Atualizar</button>
    </div>

    <div id="subs-list" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div id="card-list"></div>
  </div>
</section>

<!-- INVEST -->
    <section id="view-invest" class="view">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Investimentos (BB)</h3>

        <label>M√™s (compet√™ncia)</label>
        <input id="invest-month" type="month" />

        <div class="hint">Aba Invest considera apenas lan√ßamentos com Conta = Banco do Brasil e Categoria = Investimentos.</div>
      </div>

      <div class="card">
        <div id="invest-view"></div>
      </div>
</section>

    <!-- MAIS -->
    <section id="view-mais" class="view">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Mais</h3>
        <button class="btn" onclick="exportExcel()">üì§ Exportar Excel (m√™s)</button>
        <div class="hint">Se n√£o baixar, provavelmente √© cache antigo do GitHub Pages.</div>
      </div>
<button class="btn" id="btnPwaUpdate" type="button" onclick="checkForUpdate()">üîÑ Atualizar app</button>
<div id="pwa-update-status" class="hint"></div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Categorias & Subcategorias</h3>
        <button class="btn small" onclick="openCats()">Gerenciar</button>
        <div id="cats-preview" class="hint"></div>
      </div>

<!-- BACKUP (cole dentro de uma <section class="view">, ex.: view-launch) -->
<div class="card" id="backup-card">
  <h3 style="margin:0 0 8px 0">Backup</h3>
  <div class="hint" style="margin-top:0">
    Exporte/importe seus dados. O bot√£o ‚ÄúBackup‚Äù salva uma c√≥pia local e tamb√©m baixa um arquivo .json.
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
    <button type="button" class="btn" id="btnBackupNow">Backup</button>
    <button type="button" class="btn" id="btnImportPick">Importar (restaurar)</button>

    <input id="importFileJSON" type="file" accept="application/json,.json" style="display:none" />
  </div>

  <div id="backupMeta" class="hint" style="margin-top:10px"></div>
</div>

    </section>
  </main>

  <nav>
    <button id="tab-lancar" class="active" onclick="showView('lancar')">+ Lan√ßar</button>
    <button id="tab-mes" onclick="showView('mes')">M√™s</button>
    <button id="tab-cartao" onclick="showView('cartao')">Cart√£o</button>
    <button id="tab-invest" onclick="showView('invest')">Invest</button>
    <button id="tab-mais" onclick="showView('mais')">Mais</button>
  </nav>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="storage.js"></script>
  <script src="app.js"></script>


  <script>
  // PWA (instala como app + offline)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
  </script>

<script>
/* =========================
   BACKUP / EXPORT / IMPORT
   (pega TODAS as keys do localStorage do app)
========================= */
(function () {
  const BK_PREFIX = "__FINBK__";        // prefixo interno (para n√£o exportar os pr√≥prios backups)
  const BK_LAST   = BK_PREFIX + "LAST";
  const BK_LOCAL  = BK_PREFIX + "LOCAL"; // guarda 1 snapshot local (√∫ltimo backup)

  function pad2(n){ return String(n).padStart(2,"0"); }
  function stamp(d=new Date()){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}`;
  }
  function download(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function snapshotAll(){
    const data = {};
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k) continue;
      if (k.startsWith(BK_PREFIX)) continue; // n√£o exporta backups internos
      data[k] = localStorage.getItem(k);
    }
    return {
      app: "financeiro",
      schema: 1,
      exportedAt: new Date().toISOString(),
      data
    };
  }

  function renderMeta(){
    const el = document.getElementById("backupMeta");
    if (!el) return;
    const last = localStorage.getItem(BK_LAST);
    const hasLocal = !!localStorage.getItem(BK_LOCAL);
    el.innerHTML =
      `Backup local: <b>${hasLocal ? "sim" : "n√£o"}</b>` +
      (last ? ` ‚Ä¢ √öltimo backup: <b>${new Date(last).toLocaleString("pt-BR")}</b>` : "");
  }

  function backupNow(){
    const payload = snapshotAll();
    // salva 1 c√≥pia local
    localStorage.setItem(BK_LOCAL, JSON.stringify(payload));
    localStorage.setItem(BK_LAST, new Date().toISOString());

    // e baixa o arquivo
    const filename = `financeiro_backup_${stamp()}.json`;
    download(filename, JSON.stringify(payload, null, 2));
    renderMeta();
  }

  async function importFromFile(file){
    const text = await file.text();
    let payload;
    try { payload = JSON.parse(text); }
    catch { alert("Arquivo inv√°lido: n√£o √© JSON."); return; }

    if (!payload?.data || typeof payload.data !== "object") {
      alert("Backup inv√°lido: n√£o encontrei 'data' dentro do arquivo.");
      return;
    }

    const ok = confirm("Importar vai SUBSTITUIR os dados atuais deste navegador para este app. Continuar?");
    if (!ok) return;

    // Restaura apenas as chaves do backup (sobrescreve o que existir com o mesmo nome)
    for (const [k, v] of Object.entries(payload.data)) {
      if (typeof v === "string") localStorage.setItem(k, v);
    }

    alert("Importado! Vou recarregar a p√°gina agora.");
    location.reload();
  }

  function init(){
    const btnBackup = document.getElementById("btnBackupNow");
    const btnPick   = document.getElementById("btnImportPick");
    const input     = document.getElementById("importFileJSON");

    if (btnBackup) btnBackup.addEventListener("click", backupNow);

    if (btnPick && input){
      btnPick.addEventListener("click", () => input.click());
      input.addEventListener("change", async () => {
        const f = input.files && input.files[0];
        input.value = "";
        if (f) await importFromFile(f);
      });
    }

    renderMeta();
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
<script>
/* =========================
   PATCH: Aba INVEST (failsafe)
   - N√£o altera outras abas
   - Tenta achar automaticamente os lan√ßamentos no localStorage
========================= */
(function(){
  const $ = (sel) => document.querySelector(sel);

  function money(n){
    const v = Number(n || 0);
    return v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  }

  function asMonth(v){
    // input type="month" => "YYYY-MM"
    if (!v) return null;
    const m = String(v).trim();
    return /^\d{4}-\d{2}$/.test(m) ? m : null;
  }

  function safeParseJSON(s){
    try { return JSON.parse(s); } catch { return null; }
  }

  function isObj(x){ return x && typeof x === 'object' && !Array.isArray(x); }

  function pickTransactionsFromAnyStorage(){
    // Heur√≠stica para achar lista de lan√ßamentos no localStorage
    // Procura: array de objetos com cara de lan√ßamento OU objeto com propriedade lan√ßamentos/transa√ß√µes.
    let best = null;

    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      const raw = localStorage.getItem(k);
      if (!raw || raw.length < 2) continue;

      const data = safeParseJSON(raw);
      if (!data) continue;

      // Caso 1: objeto com propriedade lan√ßamentos/transa√ß√µes
      if (isObj(data)){
        const candidates = [
          data.lancamentos, data.lancamento, data.transacoes, data.transacao,
          data.transactions, data.transaction, data.entries, data.entry
        ].filter(Boolean);

        for (const c of candidates){
          if (Array.isArray(c) && c.length){
            const score = scoreTxArray(c);
            if (!best || score > best.score) best = { key:k, arr:c, score };
          }
        }
      }

      // Caso 2: o pr√≥prio storage √© um array
      if (Array.isArray(data) && data.length){
        const score = scoreTxArray(data);
        if (!best || score > best.score) best = { key:k, arr:data, score };
      }
    }

    return best ? best.arr : [];
  }

  function scoreTxArray(arr){
    // pontua se objetos t√™m campos t√≠picos: conta/categoria/competencia/valor/tipo
    const sample = arr.slice(0, Math.min(12, arr.length)).filter(isObj);
    if (!sample.length) return 0;

    const has = (o, ks) => ks.some(k => k in o);
    let score = 0;

    for (const o of sample){
      if (has(o, ['conta','account','bank'])) score += 3;
      if (has(o, ['categoria','category'])) score += 3;
      if (has(o, ['subcategoria','subcategory'])) score += 1;
      if (has(o, ['competencia','month','mes'])) score += 3;
      if (has(o, ['valor','value','amount'])) score += 3;
      if (has(o, ['tipo','type'])) score += 1;
      if (has(o, ['investKind','investTipo','movimento','mov'])) score += 2;
    }

    // b√¥nus se parecer ‚Äúgrande o suficiente‚Äù
    score += Math.min(5, Math.floor(arr.length / 50));
    return score;
  }

  function normStr(x){
    return String(x ?? '').trim().toLowerCase();
  }

  function getField(o, names){
    for (const n of names){
      if (o && (n in o)) return o[n];
    }
    return undefined;
  }

  function matchesBBAccount(acc){
    const a = normStr(acc);
    // cobre varia√ß√µes comuns
    return (
      a.includes('banco do brasil') ||
      a === 'bb' ||
      a.includes(' banco do brasil') ||
      a.includes('b.b.') ||
      a.includes('bdb')
    );
  }

  function matchesInvestCategory(cat){
    const c = normStr(cat);
    return c === 'investimentos' || c.includes('invest');
  }

  function monthOf(o){
    // tenta encontrar compet√™ncia: "YYYY-MM"
    const m =
      getField(o, ['competencia','month','mes']) ??
      getField(o, ['compet√™ncia']); // caso tenha acento
    const s = String(m ?? '').trim();

    // j√° vem YYYY-MM
    if (/^\d{4}-\d{2}$/.test(s)) return s;

    // tenta extrair de data real "YYYY-MM-DD"
    const d = getField(o, ['dataReal','data','date']);
    const ds = String(d ?? '').trim();
    const m2 = ds.match(/^(\d{4})-(\d{2})/);
    if (m2) return `${m2[1]}-${m2[2]}`;

    return null;
  }

  function valueOf(o){
    const v = getField(o, ['valor','value','amount']);
    const n = Number(String(v ?? '0').replace(/\./g,'').replace(',','.'));
    return Number.isFinite(n) ? n : 0;
  }

  function investKindOf(o){
    // APLIC / REND / RETIR / AJ+ / AJ-
    const k = getField(o, ['investKind','investTipo','movimento','mov']);
    return String(k ?? '').trim().toUpperCase();
  }

  function renderInvest(){
    const host = $('#invest-view');
    if (!host) return;

    // garante m√™s default
    const monthEl = $('#invest-month');
    if (monthEl && !monthEl.value){
      const now = new Date();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      monthEl.value = `${now.getFullYear()}-${mm}`;
    }
    const selectedMonth = asMonth(monthEl ? monthEl.value : null);

    // pega lan√ßamentos de onde estiverem
    const all = pickTransactionsFromAnyStorage();

    // filtra invest do BB
    let rows = all.filter(isObj).filter(o => {
      const acc = getField(o, ['conta','account','bank']);
      const cat = getField(o, ['categoria','category']);
      if (!matchesBBAccount(acc)) return false;
      if (!matchesInvestCategory(cat)) return false;
      if (selectedMonth){
        const m = monthOf(o);
        if (m !== selectedMonth) return false;
      }
      return true;
    });

    // ordena por data (se existir), sen√£o mant√©m
    rows = rows.slice().sort((a,b)=>{
      const da = String(getField(a,['dataReal','data','date']) ?? '');
      const db = String(getField(b,['dataReal','data','date']) ?? '');
      return da.localeCompare(db);
    });

    // totais (se tiver investKind, usa; sen√£o: tudo soma como ‚Äúmovimento‚Äù)
    let total = 0, aplic = 0, rend = 0, retir = 0, ajPos = 0, ajNeg = 0;

    for (const o of rows){
      const v = valueOf(o);
      const k = investKindOf(o);

      if (k === 'APLIC' || k === 'APLICA√á√ÉO' || k === 'APLICACAO'){
        aplic += Math.abs(v);
        total += Math.abs(v);
      } else if (k === 'REND' || k === 'PROVENTO' || k === 'DIVIDENDO'){
        rend += Math.abs(v);
        total += Math.abs(v);
      } else if (k === 'RETIR' || k === 'RESGATE' || k === 'VENDA'){
        retir += Math.abs(v);
        total -= Math.abs(v);
      } else if (k === 'AJUSTE (+)' || k === 'AJ+' || k === 'AJPOS'){
        ajPos += Math.abs(v);
        total += Math.abs(v);
      } else if (k === 'AJUSTE (-)' || k === 'AJ-' || k === 'AJNEG'){
        ajNeg += Math.abs(v);
        total -= Math.abs(v);
      } else {
        // fallback: se n√£o tiver tipo, soma ‚Äúcomo veio‚Äù
        total += v;
      }
    }

    // HTML
    const monthLabel = selectedMonth ? selectedMonth : '(sem m√™s selecionado)';
    host.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; margin-bottom:10px">
        <div style="flex:1; min-width:160px; padding:10px; border:1px solid var(--border,#ddd); border-radius:12px; background:var(--card,#fff)">
          <div style="font-size:12px; opacity:.75">M√™s</div>
          <div style="font-weight:700">${monthLabel}</div>
        </div>
        <div style="flex:1; min-width:160px; padding:10px; border:1px solid var(--border,#ddd); border-radius:12px; background:var(--card,#fff)">
          <div style="font-size:12px; opacity:.75">Saldo (fluxo)</div>
          <div style="font-weight:800">${money(total)}</div>
        </div>
        <div style="flex:1; min-width:160px; padding:10px; border:1px solid var(--border,#ddd); border-radius:12px; background:var(--card,#fff)">
          <div style="font-size:12px; opacity:.75">Aplica√ß√µes</div>
          <div style="font-weight:700">${money(aplic)}</div>
        </div>
        <div style="flex:1; min-width:160px; padding:10px; border:1px solid var(--border,#ddd); border-radius:12px; background:var(--card,#fff)">
          <div style="font-size:12px; opacity:.75">Rendimentos</div>
          <div style="font-weight:700">${money(rend)}</div>
        </div>
        <div style="flex:1; min-width:160px; padding:10px; border:1px solid var(--border,#ddd); border-radius:12px; background:var(--card,#fff)">
          <div style="font-size:12px; opacity:.75">Resgates</div>
          <div style="font-weight:700">${money(retir)}</div>
        </div>
      </div>

      <div style="font-size:12px; opacity:.8; margin:6px 0 10px 0">
        Itens: <b>${rows.length}</b> (Conta=BB, Categoria=Investimentos)
      </div>

      <div style="overflow:auto; border:1px solid var(--border,#ddd); border-radius:12px">
        <table style="width:100%; border-collapse:collapse; font-size:14px">
          <thead>
            <tr style="background:rgba(0,0,0,.03)">
              <th style="text-align:left; padding:10px; white-space:nowrap">Data</th>
              <th style="text-align:left; padding:10px; white-space:nowrap">Tipo</th>
              <th style="text-align:left; padding:10px">Descri√ß√£o</th>
              <th style="text-align:right; padding:10px; white-space:nowrap">Valor</th>
            </tr>
          </thead>
          <tbody>
            ${
              rows.map(o=>{
                const d = getField(o,['dataReal','data','date']) ?? '';
                const k = investKindOf(o) || (getField(o,['tipo','type']) ?? '');
                const desc = getField(o,['descricao','desc','description']) ?? '';
                const v = valueOf(o);
                return `
                  <tr style="border-top:1px solid rgba(0,0,0,.06)">
                    <td style="padding:10px; white-space:nowrap">${String(d)}</td>
                    <td style="padding:10px; white-space:nowrap">${String(k)}</td>
                    <td style="padding:10px">${String(desc)}</td>
                    <td style="padding:10px; text-align:right; white-space:nowrap">${money(v)}</td>
                  </tr>
                `;
              }).join('')
              || `<tr><td colspan="4" style="padding:12px; opacity:.75">Nenhum lan√ßamento de investimento encontrado para este m√™s.</td></tr>`
            }
          </tbody>
        </table>
      </div>
    `;
  }

  // Re-render quando mudar o m√™s
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === 'invest-month'){
      renderInvest();
    }
  });

  // Hook no showView existente (sem quebrar o original)
  const originalShowView = window.showView;
  if (typeof originalShowView === 'function'){
    window.showView = function(view){
      const r = originalShowView.apply(this, arguments);
      if (String(view).toLowerCase() === 'invest'){
        try { renderInvest(); } catch (err) {
          const host = $('#invest-view');
          if (host) host.innerHTML = `<div style="padding:10px">Erro ao renderizar Invest: <pre style="white-space:pre-wrap">${String(err)}</pre></div>`;
          console.error(err);
        }
      }
      return r;
    };
  } else {
    // se showView n√£o existir por algum motivo, tenta renderizar mesmo assim quando a p√°gina carregar
    window.addEventListener('load', ()=>{ try{ renderInvest(); }catch(e){} });
  }
})();
</script>
</body>
</html>
